# Gmod MongoDB Wrapper (WIP)

This is a Garry's Mod module to expose all [.NET MongoDB Driver](https://docs.mongodb.com/drivers/csharp/) functionality to Lua. This module is built using [Gmod.NET](https://github.com/GmodNET/GmodDotNet).

## ðŸš§ WIP! (Unstable Code)
This project is under active development. There is no versioning yet and there is only these guarantees:
* **Everything may change.**
* **Code will change radically and break.**

## Requirements

* Install the correct version of [Gmod.NET](https://github.com/GmodNET/GmodDotNet).    
    [&raquo; Check the dependencies for the version](https://github.com/luttje/gmod-net-mongodb/network/dependencies)
* You must be on the `x86_64` beta branch of Garry's Mod.
* You must have a MongoDB Server installed and running.    
    [&raquo; Get the MongoDB Community Server here](https://www.mongodb.com/try/download/community)

## Documentation

When I push to the `main` branch documentation will be generated by a GitHub Workflow using [DocFx](https://dotnet.github.io/docfx/). You can find those docs on [this GitHub Pages Environment](https://luttje.github.io/gmod-net-mongodb/).

Besides that documentation you may find the [.NET MongoDB Driver Documentation](https://mongodb.github.io/mongo-csharp-driver/2.12/reference/) helpful. It is my goal to have it map as close to 1-to-1 as possible in Lua.

## Basic Instructions

### Connecting
First load this module using the Gmod&period;NET function `dotnet.load`:
```lua
dotnet.load("GmodMongoDb")
```

Instantiate a client using a valid MongoDB connection string:
```lua
client = mongo.NewClient("mongodb://myusername:superdupersecretpassword@127.0.0.1:27017/myappname?retryWrites=true&w=majority")
```
*You should only have a single client. You can re-use that for multiple different databases.*

### Fetching data
Get a database object, then get a collection object from it:
```lua
local db = client:GetDatabase("myappname")
local collection = db:GetCollection("players")
```

You can query the collection using a table as a filter. *The table will be converted to a BSON Document*:
```lua
local filter = { _id = "STEAM_0:1:123456" }
local results = collection:Find(filter)
PrintTable(results)
```

You can also construct your own BSON Document explicitly:
```lua
local filter = mongo.NewBsonDocument({ someKey = "a value", anotherKey = "another value" })
local results = collection:Find(filter)
PrintTable(results)
```

Optionally you could use a json string instead to build a BSON Document from it:
```lua
local filterJson = util.TableToJSON(filter)
local results = collection:Find(filterJson)
PrintTable(results)
```

### Iterating results
You can loop over the results with a standard loop:
```lua
for k, result in ipairs(results)do
  print(k, result)
end
```

Looping a BSON document requires use of the `bsonDocument:Pairs()` method:
```lua
local bsonDocument = results[1]

for key, value in bsonDocument:Pairs() do
  print(key, value)
end
```
*Note: BSON Documents do implement __pairs, but this is only supported from Lua 5.2 (Garry's Mod is currently at 5.1). This means you cant use the regular Lua `pairs` function.*

### Some more functions
```lua
PrintTable(client:ListDatabaseNames())
```

```lua
local databases = client:ListDatabases()

-- Iterate all databases
for i, database in pairs(databases) do
  -- Iterate the database information
  for key, value in database:Pairs() do
    print(key, value)
  end
end
```

### Asynchronous functions
The functions above are all synchronous. Most, if not all, methods that take some time have an asynchronous variant. Simply suffix Async behind the function name and pass a callback function as the final argument:
```lua
client:ListDatabaseNamesAsync(function(databases)
  PrintTable(databases)
end)
```

This asynchronous function doesn't require a callback (but it does support it). Most do other  asynchronous functions do require a callback.
```lua
client:DropDatabaseAsync("remove_me")
```

## Known issues

When connecting and swiftly unloading the module with `dotnet.unload("GmodMongoDb")` some handles may linger. Because of this the module fails to unload. You may have to restart Garry's Mod, because it keeps the module `.dll` in use.

## Contributing

If you have some suggestions or questions feel free to drop an issue.
